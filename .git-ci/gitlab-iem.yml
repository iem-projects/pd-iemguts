variables:
  PDVERSION: 0.50-2
  SRCDIR: .
  IEM_CI_PKGLIBDIR: .git-ci/_build/

.script:make: &script_make
    - echo ${TARGETARCH}
    - make -C "${SRCDIR}" ${pd_extension:+extension=}${pd_extension} ${TARGETARCH:+PLATFORM=}${TARGETARCH}
.script:make_check: &script_make_check
    # the 'make --version' invocation is used to detect cross-compilation
    - if make --version | egrep $(${CC:-cc} -dumpmachine | sed -e 's|-.*-|-.*-|') && make -C "${SRCDIR}" check -n ${pd_extension:+extension=}${pd_extension} >/dev/null 2>&1 ; then make -C "${SRCDIR}" check ${pd_extension:+extension=}${pd_extension}; else echo "no 'check' target...skipping"; fi
.script:make_install: &script_make_install
    - rm -rf "${IEM_CI_PKGLIBDIR}"
    - make -C "${SRCDIR}" install ${pd_extension:+extension=}${pd_extension} DESTDIR="$(pwd)" pkglibdir="/${IEM_CI_PKGLIBDIR}/"
    - rm -rf "${CI_PROJECT_NAME}"
    - mv "${IEM_CI_PKGLIBDIR}/${CI_PROJECT_NAME}" .


#######################################################################
### configuration templates (to be used for snapshot and release builds)
.build:script:
  stage: build
  script:
    - *script_make

.build:linux: &build_linux
  extends: .build:script
  image: gcc
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends make puredata-dev puredata-core
    - if [ -e .git-ci/requirements.apt ]; then apt-get install -y --no-install-recommends $(cat .git-ci/requirements.apt | sed -e '/^#/d'); fi
    - export PD=/usr/bin/pd

.build:linux_armhf: &build_linux_armhf
  extends: .build:linux
  image: registry.git.iem.at/devtools/docker/debiancross:armhf
  variables:
    pd_extension: l_arm

LinuxARMhf:
  allow_failure: true
  <<: *build_linux_armhf
